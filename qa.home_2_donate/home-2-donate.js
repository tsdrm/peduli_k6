// Auto-generated by the Load Impact converter

import "./libs/shim/core.js";
import "./libs/shim/expect.js";
import "./libs/shim/urijs.js";
import { group } from "k6";

export let options = { maxRedirects: 4 };

const Pre = Symbol.for("pre");
const Post = Symbol.for("post");
const Request = Symbol.for("request");
postman[Symbol.for("initial")]({
  options,
  environment: {
    "project-host": "https://project-qa.pedulisehat.id",
    "passport-host": "https://passport-qa.pedulisehat.id",
    "psuic-host": "https://psuic-qa.pedulisehat.id",
    "trade-host": "https://trade-qa.pedulisehat.id",
    "activity-host": "https://activity-qa.pedulisehat.id",
    "share-host": "https://share-qa.pedulisehat.id",
    project_short_link: "campaign20190628001",
    requestBody: '{"project_id":""}'
  }
});

export default function() {
  postman[Pre].push(() => {
    // 预定义13位时间戳
    pm.globals.set("timestamp13", Math.round(new Date()));
  });
  postman[Post].push(() => {
    // 每个请求设置超时时间，超过10s则认为断言失败
    var cost = pm.response.responseTime;
    pm.test("responseTime is: " + cost, function() {
      pm.expect(cost).to.be.below(10000);
    });

    // 请求的返回值判断是否为200

    // // 用户信息接口可能200，401
    // var request401 = [];

    // if (request401.indexOf(pm.request.url.path) > -1) {
    //     pm.expect(pm.response.code).to.be.oneOf([200,401]);
    //     return;
    // }

    // 其余判断为200
    pm.test[
      ("response code is not 200 or 401",
      function() {
        pm.expect(pm.response.code).to.be.oneOf([200, 401]);
      })
    ];
  });

  group("home-page", function() {
    postman[Request]({
      name: "project_search_history",
      id: "d69297d6-6f40-43ef-a8d8-1ef747c769d3",
      method: "GET",
      address: "{{project-host}}/v1/project_search_history?_={{timestamp13}}"
    });

    postman[Request]({
      name: "user",
      id: "638846c2-20e4-4984-aa15-e7a6f82bc677",
      method: "GET",
      address: "{{passport-host}}/v1/user?_={{timestamp13}}"
    });

    postman[Request]({
      name: "search_popular_word",
      id: "87709474-18eb-4267-bb04-95bd2b19c475",
      method: "GET",
      address: "{{project-host}}/v1/search_popular_word?_={{timestamp13}}"
    });

    postman[Request]({
      name: "public",
      id: "7f22ff5e-d3d9-42c5-88b0-d0c6918e68b3",
      method: "GET",
      address:
        "{{project-host}}/v1/public?page=1&limit=20&category_id=12,13&_={{timestamp13}}",
      post(response) {
        var body = JSON.parse(responseBody) || {};
        var data = body.data;

        // 断言项目列表长度大于2，取第二个项目为测试例子
        pm.test("[home-page] public data length is above 2", function() {
          pm.expect(data.length).to.be.above(2);
        });

        var project = data[1] || {};

        // 断言短链的长度不为空
        pm.test("[home-page] public shor_ling is valid", function() {
          pm.expect(project.short_link.length).to.be.above(1);
        });

        pm.globals.set("project_short_link", project.short_link);
      }
    });

    postman[Request]({
      name: "banner",
      id: "5dd67b5f-be3f-4d3e-a6c9-8bcaa738453f",
      method: "GET",
      address: "{{project-host}}/v1/banner?_={{timestamp13}}"
    });

    postman[Request]({
      name: "level_rules",
      id: "4a9ebce6-1951-47b8-8342-db85d58387d7",
      method: "GET",
      address: "{{psuic-host}}/v1/level_rules?_={{timestamp13}}"
    });

    postman[Request]({
      name: "user_level",
      id: "f003649d-79f4-4902-8cb8-4a237decc930",
      method: "GET",
      address: "{{psuic-host}}/v1/user_level?_={{timestamp13}}"
    });
  });

  group("project-detail", function() {
    postman[Request]({
      name: "detail",
      id: "98befe76-2386-4777-8154-17551e27bf00",
      method: "GET",
      address:
        "{{project-host}}/v1/project/detail?project_id=&short_link={{project_short_link}}&_={{timestamp13}}",
      post(response) {
        var body = JSON.parse(responseBody) || {};
        var data = body.data || {};

        // 判断字段的是否存在
        var user_id = data.user_id;
        var project_id = data.project_id;

        pm.variables.set("user_id", user_id);
        pm.variables.set("project_id", project_id);
      }
    });

    postman[Request]({
      name: "detail_id_link",
      id: "3533cbb0-9c69-4966-9964-440334328b5d",
      method: "GET",
      address:
        "{{project-host}}/v1/project/dynamic/update/detail?project_id={{project_id}}&short_link={{project_short_link}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "share_short_link",
      id: "a0a8af0e-0685-4377-8442-62bbee31015a",
      method: "POST",
      address: "{{share-host}}/v1/share_short_link",
      data: "{{requestBody}}",
      headers: {
        "Content-Type": "application/json"
      },
      pre() {
        var project_id = pm.variables.get("project_id");
        var project_short_link = pm.variables.get("project_short_link");
        var requestBody = {
          item_id: project_id,
          item_type: 1,
          item_short_link: project_short_link
        };
      }
    });

    postman[Request]({
      name: "project_pv",
      id: "ac1b999f-2a4b-4c8d-a4b6-499cf06e068c",
      method: "POST",
      address: "{{project-host}}/v1/project_pv",
      data: "{{requestBody}}",
      headers: {
        "Content-Type": "application/json"
      },
      pre() {
        var project_short_link = pm.globals.get("project_short_link");
        var requestBody = {
          project_id: "",
          short_link: project_short_link
        };

        pm.variables.set("requestBody", JSON.stringify(requestBody));
      }
    });

    postman[Request]({
      name: "show",
      id: "c5d0d19e-78fa-431a-b2e4-5a1771773a5a",
      method: "GET",
      address:
        "{{project-host}}/v1/project_verify/{{project_id}}/show?_={{timestamp13}}"
    });

    postman[Request]({
      name: "statistics",
      id: "c4bdf7a0-f71b-4725-9739-63b268fdf631",
      method: "GET",
      address:
        "{{project-host}}/v1/statistics?project_id={{project_id}}&short_link={{project_short_link}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "project_link",
      id: "a0a643ad-9046-45e9-8569-fbb50d14adfa",
      method: "GET",
      address:
        "{{project-host}}/v1/project_link?project_id={{project_id}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "donated_carousels",
      id: "3659d4fb-33f6-47cc-ac34-abeeb85ffac1",
      method: "GET",
      address:
        "{{trade-host}}/v1/donated_carousels?limit=200&project_id={{project_id}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "project_confirm",
      id: "9670d5cd-16de-440d-baca-775bbc52215a",
      method: "GET",
      address:
        "{{project-host}}/v1/project_confirm?project_id={{project_id}}&short_link={{project_short_link}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "activities",
      id: "2b3cd6ab-7043-48ef-b32b-79aa1fc49054",
      method: "GET",
      address:
        "{{project-host}}/v1/activities?project_id={{project_id}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "partner_card",
      id: "0ce105db-f763-4662-8e0e-4b97d555dc1d",
      method: "GET",
      address:
        "{{activity-host}}/v1/prr/partner_card?project_id={{project_id}}&_={{timestamp13}}"
    });
  });

  group("donate", function() {
    postman[Request]({
      name: "detail",
      id: "40b1f1fa-c540-4e5a-acc0-8c0ff1760688",
      method: "GET",
      address:
        "{{project-host}}/v1/project/detail?project_id={{project_id}}&short_link={{project_short_link}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "pay_channel",
      id: "84a19a36-97bb-467b-b252-50d9600e49ac",
      method: "GET",
      address: "{{trade-host}}/v2/pay_channel?_={{timestamp13}}"
    });
  });

  postman[Pre].pop();
  postman[Post].pop();
}
