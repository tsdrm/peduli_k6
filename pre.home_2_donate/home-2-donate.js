// Auto-generated by the Load Impact converter

import "./libs/shim/core.js";
import "./libs/shim/expect.js";
import "./libs/shim/urijs.js";
import { group } from "k6";

export let options = { maxRedirects: 4 };

const Pre = Symbol.for("pre");
const Post = Symbol.for("post");
const Request = Symbol.for("request");
postman[Symbol.for("initial")]({
  options,
  environment: {
    "project-host": "https://project-pre.pedulisehat.id",
    "passport-host": "https://passport-pre.pedulisehat.id",
    "psuic-host": "https://psuic-pre.pedulisehat.id",
    "trade-host": "https://trade-pre.pedulisehat.id",
    "activity-host": "https://activity-pre.pedulisehat.id",
    "share-host": "https://share-pre.pedulisehat.id",
    project_short_link: "campaign20190628001",
    requestBody: '{"project_id":""}'
  }
});

export default function() {
  postman[Pre].push(() => {
    // 预定义13位时间戳
    pm.globals.set("timestamp13", Math.round(new Date()));
  });
  postman[Post].push(() => {
    // 每个请求设置超时时间，超过10s则认为断言失败
    var cost = pm.response.responseTime;
    pm.test("responseTime is: " + cost, function() {
      pm.expect(cost).to.be.below(10000);
    });

    // 请求的返回值判断是否为200

    // // 用户信息接口可能200，401
    // var request401 = [];

    // if (request401.indexOf(pm.request.url.path) > -1) {
    //     pm.expect(pm.response.code).to.be.oneOf([200,401]);
    //     return;
    // }

    // 其余判断为200
    pm.test("response code is not 200 or 401", function() {
      pm.expect(pm.response.code).to.be.oneOf([200, 401]);
    });
  });

  group("home-page", function() {
    postman[Request]({
      name: "project_search_history",
      id: "21cb4376-02fe-4cb8-8e78-05be3449f60c",
      method: "GET",
      address: "{{project-host}}/v1/project_search_history?_={{timestamp13}}"
    });

    postman[Request]({
      name: "user",
      id: "2f5b7c1b-515a-4ece-a170-501ef8429cd3",
      method: "GET",
      address: "{{passport-host}}/v1/user?_={{timestamp13}}"
    });

    postman[Request]({
      name: "search_popular_word",
      id: "47612600-fe1b-44d9-9396-0bb17b06119b",
      method: "GET",
      address: "{{project-host}}/v1/search_popular_word?_={{timestamp13}}"
    });

    postman[Request]({
      name: "public",
      id: "038afd60-815d-4652-86a5-2baadde4594e",
      method: "GET",
      address:
        "{{project-host}}/v1/public?page=1&limit=20&category_id=12,13&_={{timestamp13}}",
      post(response) {
        var body = JSON.parse(responseBody) || {};
        var data = body.data || [];

        // 断言项目列表长度大于2，取第二个项目为测试例子
        pm.test("[home-page] public data length is above 2", function() {
          pm.expect(data.length).to.be.above(2);
        });

        var project = data[1] || {};

        // 断言短链的长度不为空
        pm.test("[home-page] public shor_ling is valid", function() {
          pm.expect(project.short_link.length).to.be.above(1);
        });

        pm.globals.set("project_short_link", project.short_link);
      }
    });

    postman[Request]({
      name: "banner",
      id: "a36c6ece-9dc9-496f-bd24-cfe29b5b8d1c",
      method: "GET",
      address: "{{project-host}}/v1/banner?_={{timestamp13}}"
    });

    postman[Request]({
      name: "level_rules",
      id: "834970d4-6171-4049-81d7-4bd41b789652",
      method: "GET",
      address: "{{psuic-host}}/v1/level_rules?_={{timestamp13}}"
    });

    postman[Request]({
      name: "user_level",
      id: "b8229dc4-26d3-443f-a801-7efa7cb45d89",
      method: "GET",
      address: "{{psuic-host}}/v1/user_level?_={{timestamp13}}"
    });
  });

  group("project-detail", function() {
    postman[Pre].push(() => {
      // var project_short_link = pm.globals.get("project_short_link");
      // if (!project_short_link || project_short_link === '' ||  project_short_link.indexOf("campaign") === -1) {
      //     pm.globals.set("project_short_link", 'campaign20190628001');
      // }
    });

    postman[Request]({
      name: "detail",
      id: "32016d40-fa0b-457d-bf45-9bfdbd8a7fcb",
      method: "GET",
      address:
        "{{project-host}}/v1/project/detail?project_id=&short_link={{project_short_link}}&_={{timestamp13}}",
      post(response) {
        var body = JSON.parse(responseBody) || {};
        var data = body.data || {};

        // 判断字段的是否存在
        var user_id = data.user_id + "";
        var project_id = data.project_id + "";

        // console.log('detail ---', user_id, "---", project_id);

        pm.globals.set("user_id", user_id);
        pm.globals.set("project_id", project_id);
        pm.variables.set("project_id", project_id);
      }
    });

    postman[Request]({
      name: "detail_id_link",
      id: "772f908f-6a65-4d35-b4c0-153567ea58bb",
      method: "GET",
      address:
        "{{project-host}}/v1/project/dynamic/update/detail?project_id={{project_id}}&short_link={{project_short_link}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "share_short_link",
      id: "fe51e36f-5dd5-41c0-93e2-0c8a9501683c",
      method: "POST",
      address: "{{share-host}}/v1/share_short_link",
      data: "{{requestBody}}",
      headers: {
        "Content-Type": "application/json"
      },
      pre() {
        var project_id = pm.variables.get("project_id");
        var project_short_link = pm.globals.get("project_short_link");
        var requestBody = {
          item_id: project_id,
          item_type: 1,
          item_short_link: project_short_link
        };
        pm.variables.set("requestBody", JSON.stringify(requestBody));
      }
    });

    postman[Request]({
      name: "project_pv",
      id: "8a942696-6a8f-49aa-a670-2d514525ddc8",
      method: "POST",
      address: "{{project-host}}/v1/project_pv",
      data: "{{requestBody}}",
      headers: {
        "Content-Type": "application/json"
      },
      pre() {
        var project_short_link = pm.globals.get("project_short_link");
        var requestBody = {
          project_id: "",
          short_link: project_short_link
        };

        pm.variables.set("requestBody", JSON.stringify(requestBody));
      }
    });

    postman[Request]({
      name: "show",
      id: "8503158a-357b-44c1-97aa-ea55ea1aa09e",
      method: "GET",
      address:
        "{{project-host}}/v1/project_verify/{{project_id}}/show?_={{timestamp13}}",
      pre() {
        var project_id = pm.variables.get("project_id");
        // console.log('-------', project_id);
      }
    });

    postman[Request]({
      name: "statistics",
      id: "b2423d3e-af85-4272-8deb-26c0966857bb",
      method: "GET",
      address:
        "{{project-host}}/v1/statistics?project_id={{project_id}}&short_link={{project_short_link}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "project_link",
      id: "e4ede7ef-6d49-4745-8442-3721bbc02a6e",
      method: "GET",
      address:
        "{{project-host}}/v1/project_link?project_id={{project_id}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "donated_carousels",
      id: "092628a1-c838-44bd-927d-2a23f3c22113",
      method: "GET",
      address:
        "{{trade-host}}/v1/donated_carousels?limit=200&project_id={{project_id}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "project_confirm",
      id: "931b716d-5dde-4352-81c3-fea445901e7b",
      method: "GET",
      address:
        "{{project-host}}/v1/project_confirm?project_id={{project_id}}&short_link={{project_short_link}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "activities",
      id: "c0db2234-1dc1-49b7-80a7-a26b4a924ed2",
      method: "GET",
      address:
        "{{project-host}}/v1/activities?project_id={{project_id}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "partner_card",
      id: "2964e77d-7991-498e-89c3-343602ad3c7b",
      method: "GET",
      address:
        "{{activity-host}}/v1/prr/partner_card?project_id={{project_id}}&_={{timestamp13}}"
    });

    postman[Pre].pop();
  });

  group("donate", function() {
    postman[Pre].push(() => {
      // var project_id = pm.variables.get("project_id") + '';
      // var project_short_link = pm.variables.get("project_short_link");
      // if (!project_short_link || project_short_link === '' || project_short_link.indexOf("campaign") === -1) {
      //     pm.globals.set("project_short_link", 'campaign20190628001');
      // }
      // if (!project_id || project_id === ''){
      //     pm.globals.set("project_id", '14221178668964681602');
      // }
    });

    postman[Request]({
      name: "detail",
      id: "e229e313-828b-4fec-9e29-7026a25e5371",
      method: "GET",
      address:
        "{{project-host}}/v1/project/detail?project_id={{project_id}}&short_link={{project_short_link}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "pay_channel",
      id: "41a806db-cf33-4d53-9734-2d077817a82e",
      method: "GET",
      address: "{{trade-host}}/v2/pay_channel?_={{timestamp13}}"
    });

    postman[Pre].pop();
  });

  postman[Pre].pop();
  postman[Post].pop();
}
