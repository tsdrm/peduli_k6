// Auto-generated by the Load Impact converter

import "./libs/shim/core.js";
import "./libs/shim/expect.js";
import "./libs/shim/urijs.js";
import { group } from "k6";

export let options = { maxRedirects: 4 };

const Pre = Symbol.for("pre");
const Post = Symbol.for("post");
const Request = Symbol.for("request");
postman[Symbol.for("initial")]({
  options,
  environment: {
    "project-host": "https://project-qa.pedulisehat.id",
    "passport-host": "https://passport-qa.pedulisehat.id",
    "psuic-host": "https://psuic-qa.pedulisehat.id",
    "trade-host": "https://trade-qa.pedulisehat.id",
    "activity-host": "https://activity-qa.pedulisehat.id",
    "share-host": "https://share-qa.pedulisehat.id",
    project_short_link: "campaign20190628001",
    requestBody: '{"project_id":""}'
  }
});

export default function() {
  postman[Pre].push(() => {
    // 预定义13位时间戳
    pm.globals.set("timestamp13", Math.round(new Date()));
  });
  postman[Post].push(() => {
    // 每个请求设置超时时间，超过10s则认为断言失败
    var cost = pm.response.responseTime;
    pm.test("responseTime is: " + cost, function() {
      pm.expect(cost).to.be.below(10000);
    });

    // 请求的返回值判断是否为200

    // // 用户信息接口可能200，401
    // var request401 = [];

    // if (request401.indexOf(pm.request.url.path) > -1) {
    //     pm.expect(pm.response.code).to.be.oneOf([200,401]);
    //     return;
    // }

    // 其余判断为200
    pm.test[
      ("response code is not 200 or 401",
      function() {
        pm.expect(pm.response.code).to.be.oneOf([200, 401]);
      })
    ];
  });

  group("home-page", function() {
    postman[Request]({
      name: "project_search_history",
      id: "5e4204f0-dfd2-4cfb-913e-2a42ebf47250",
      method: "GET",
      address: "{{project-host}}/v1/project_search_history?_={{timestamp13}}"
    });

    postman[Request]({
      name: "user",
      id: "fee5619d-3084-4d58-9a43-c9c09a7170d9",
      method: "GET",
      address: "{{passport-host}}/v1/user?_={{timestamp13}}"
    });

    postman[Request]({
      name: "search_popular_word",
      id: "1c073587-d575-4734-8408-5e2b201d42cb",
      method: "GET",
      address: "{{project-host}}/v1/search_popular_word?_={{timestamp13}}"
    });

    postman[Request]({
      name: "public",
      id: "ae6d5dfd-c4d6-4ef0-afc2-af42edc5cc67",
      method: "GET",
      address:
        "{{project-host}}/v1/public?page=1&limit=20&category_id=12,13&_={{timestamp13}}",
      post(response) {
        var body = JSON.parse(responseBody) || {};
        var data = body.data;

        // 断言项目列表长度大于2，取第二个项目为测试例子
        pm.test("[home-page] public data length is above 2", function() {
          pm.expect(data.length).to.be.above(2);
        });

        var project = data[1] || {};

        // 断言短链的长度不为空
        pm.test("[home-page] public shor_ling is valid", function() {
          pm.expect(project.short_link.length).to.be.above(1);
        });

        pm.globals.set("project_short_link", project.short_link);
      }
    });

    postman[Request]({
      name: "banner",
      id: "c7b5dfa3-c105-463d-9c23-caef3ab0c675",
      method: "GET",
      address: "{{project-host}}/v1/banner?_={{timestamp13}}"
    });

    postman[Request]({
      name: "level_rules",
      id: "51a3da30-b5db-4f90-a7bf-d4bbf04a8216",
      method: "GET",
      address: "{{psuic-host}}/v1/level_rules?_={{timestamp13}}"
    });

    postman[Request]({
      name: "user_level",
      id: "0b7cec3f-d7a2-4653-901a-45147b0cd4a0",
      method: "GET",
      address: "{{psuic-host}}/v1/user_level?_={{timestamp13}}"
    });
  });

  group("project-detail", function() {
    postman[Request]({
      name: "detail",
      id: "9665df37-ae53-45b2-add9-a3840198bea8",
      method: "GET",
      address:
        "{{project-host}}/v1/project/detail?project_id=&short_link={{project_short_link}}&_={{timestamp13}}",
      post(response) {
        var body = JSON.parse(responseBody) || {};
        var data = body.data || {};

        // 判断字段的是否存在
        var user_id = data.user_id;
        var project_id = data.project_id;

        pm.variables.set("user_id", user_id);
        pm.variables.set("project_id", project_id);
      }
    });

    postman[Request]({
      name: "detail_id_link",
      id: "db196bb4-34a3-4a98-9c77-323a503d61b3",
      method: "GET",
      address:
        "{{project-host}}/v1/project/dynamic/update/detail?project_id={{project_id}}&short_link={{project_short_link}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "share_short_link",
      id: "ee80d03c-77f0-4127-bfc4-c0680c45f7c2",
      method: "POST",
      address: "{{share-host}}/v1/share_short_link",
      data: "{{requestBody}}",
      headers: {
        "Content-Type": "application/json"
      },
      pre() {
        var project_id = pm.variables.get("project_id");
        var project_short_link = pm.variables.get("project_short_link");
        var requestBody = {
          item_id: project_id,
          item_type: 1,
          item_short_link: project_short_link
        };
      }
    });

    postman[Request]({
      name: "project_pv",
      id: "a6ddb38c-53f9-4ea0-b778-ea3a48529bd5",
      method: "POST",
      address: "{{project-host}}/v1/project_pv",
      data: "{{requestBody}}",
      headers: {
        "Content-Type": "application/json"
      },
      pre() {
        var project_short_link = pm.globals.get("project_short_link");
        var requestBody = {
          project_id: "",
          short_link: project_short_link
        };

        pm.variables.set("requestBody", JSON.stringify(requestBody));
      }
    });

    postman[Request]({
      name: "show",
      id: "3004d520-dd7e-4e56-9fc3-61e09fe6834d",
      method: "GET",
      address:
        "{{project-host}}/v1/project_verify/{{project_id}}/show?_={{timestamp13}}"
    });

    postman[Request]({
      name: "statistics",
      id: "cf55c9ec-b945-4ec9-9e10-c402ecf19ddb",
      method: "GET",
      address:
        "{{project-host}}/v1/statistics?project_id={{project_id}}&short_link={{project_short_link}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "project_link",
      id: "883095ec-37c7-4dda-9dff-bb2003a7cb99",
      method: "GET",
      address:
        "{{project-host}}/v1/project_link?project_id={{project_id}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "donated_carousels",
      id: "ffc6bded-94fa-49b7-ae2f-2f0d1d2f387f",
      method: "GET",
      address:
        "{{trade-host}}/v1/donated_carousels?limit=200&project_id={{project_id}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "project_confirm",
      id: "a984b3d7-a26a-4466-9477-9bd147a7283b",
      method: "GET",
      address:
        "{{project-host}}/v1/project_confirm?project_id={{project_id}}&short_link={{project_short_link}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "activities",
      id: "1a5d32d4-8c58-4bfb-9d52-ba8fb5f2bcf2",
      method: "GET",
      address:
        "{{project-host}}/v1/activities?project_id={{project_id}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "partner_card",
      id: "fddbb8e4-19dc-4064-84ed-390d9f0bb4c4",
      method: "GET",
      address:
        "{{activity-host}}/v1/prr/partner_card?project_id={{project_id}}&_={{timestamp13}}"
    });
  });

  group("donate", function() {
    postman[Request]({
      name: "detail",
      id: "457e786b-12e1-4883-8ec8-b3946967bfe9",
      method: "GET",
      address:
        "{{project-host}}/v1/project/detail?project_id={{project_id}}&short_link={{project_short_link}}&_={{timestamp13}}"
    });

    postman[Request]({
      name: "pay_channel",
      id: "49d5b2fb-6100-456b-a7d1-880cf70e6203",
      method: "GET",
      address: "{{trade-host}}/v2/pay_channel?_={{timestamp13}}"
    });
  });

  postman[Pre].pop();
  postman[Post].pop();
}
